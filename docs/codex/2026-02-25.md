# Codex Log — 2026-02-25

## Session context
- Repo: Dark-Code
- Environment: conda env = darkcode
- Goal: Fate V1 (Streamlit + SQLite)

---

## Task 1
### User prompt (verbatim)
（把你发给 Codex 的指令原样贴在这里）

### Plan (by Codex)
（Codex 说的计划/步骤）

### Changes
- Files changed:
- DB schema changes:
- UI changes:
- Commands run:

### Commits
- SHA:
- Message:

### Notes / Decisions
- (记录关键决策：例如“加权进度条定义”)

### Next
- (下一步要做什么)
Make all visible UI strings use the label system L(key, default) and add missing keys for: Habits section title, Save Habits, Mainline Push title, all form headings (Add/Edit Habit/Line/Quest), messages (No remaining quests), and Yes/No. Extend the UI Labels Editor to include these keys and likely keys.

Plan summary:
- Audited UI strings and defined label keys/defaults.
- Refactored UI to use label system everywhere, including Yes/No and messages.
- Expanded UI Labels Editor with new keys.

Commands run:
- ls
- ls docs/codex
- sed -n '1,200p' PRD_V1.md
- rg -n "L\(|ui_labels|label" src/fate_app src/fate_core
- sed -n '1,220p' src/fate_app/app.py
- sed -n '220,520p' src/fate_app/app.py
- sed -n '160,320p' src/fate_app/app.py
- sed -n '320,460p' src/fate_app/app.py
- rg -n '"[^"\\n]+"' src/fate_app/app.py

Files changed:
- src/fate_app/app.py

Commit SHAs:
- None

Make Evidence Type extensible: allow users to add and delete custom evidence types. Prefer a small DB table evidence_types (id, name, active, sort_order). In "Today", use a selectbox of existing types + a text input to add a new type. Evidence type should be optional; evidence_text and evidence_ref remain required.

Plan summary:
- Added evidence_types table with seed defaults.
- Implemented CRUD helpers for evidence types.
- Updated Today evidence form to add/delete types and save optional evidence type.

Commands run:
- rg -n "evidence" src/fate_core src/fate_app
- sed -n '1,220p' src/fate_core/db.py
- sed -n '1,260p' src/fate_core/crud.py
- sed -n '260,520p' src/fate_core/crud.py
- sed -n '20,120p' src/fate_app/app.py
- sed -n '120,200p' src/fate_app/app.py
- rg -n "EVIDENCE_TYPES|evidence_type_label" src/fate_app/app.py

Files changed:
- src/fate_core/db.py
- src/fate_core/crud.py
- src/fate_app/app.py

Commit SHAs:
- None

Refactor Consistency (Habits) page UI: show a list/table of habits; editing and adding forms must be inside collapsible st.expander sections.

Plan summary:
- Added habits table/list view.
- Wrapped add/edit forms in expanders.

Commands run:
- None

Files changed:
- src/fate_app/app.py

Commit SHAs:
- None

Refactor Mainlines page UI: collapsible add/edit sections; group quests by chapter; display weighted progress bars for line and chapter using difficulty weights (active quests only).

Plan summary:
- Added label keys for weighted progress and uncategorized chapter.
- Refactored Mainlines UI into expanders and grouped quests by chapter.
- Added weighted progress bars for line and chapters using active quests only.

Commands run:
- None

Files changed:
- src/fate_app/app.py

Commit SHAs:
- None

Implement habit scheduling so that habits can be active only on certain days.

Add a scheduling model for habits: schedule_type = always/weekly/interval/cooldown. Prefer a new table habit_schedules keyed by habit_id

Implement habit scheduling so that habits can be active only on certain days.

Add a scheduling model for habits: schedule_type = always/weekly/interval/cooldown. Prefer a new table habit_schedules keyed by habit_id

Plan summary:
- Added habit_schedules table with defaults for existing habits.
- Added CRUD helpers and scheduling logic to filter habits per date.
- Updated UI to configure schedules and list schedule summaries; Today uses scheduled habits.

Commands run:
- rg -n "habit" src/fate_core/rules.py src/fate_core/crud.py src/fate_app/app.py
- sed -n '1,220p' src/fate_core/rules.py

Files changed:
- src/fate_core/db.py
- src/fate_core/crud.py
- src/fate_core/rules.py
- src/fate_app/app.py

Commit SHAs:
- None

Cooldown schedule: support cooldown_days (e.g., 14). Store next_due_date; habit is active when date >= next_due_date and remains active until marked done; when marked done, set next_due_date = done_date + cooldown_days.

Plan summary:
- Added next_due_date column to habit_schedules with safe migration.
- Updated cooldown scheduling logic to respect next_due_date.
- Set next_due_date on habit completion and surfaced in schedule summary.

Commands run:
- None

Files changed:
- src/fate_core/db.py
- src/fate_core/crud.py
- src/fate_core/rules.py
- src/fate_app/app.py

Commit SHAs:
- None

make new ui words editable in the UI

Plan summary:
- No code change needed; new UI words already mapped in LABEL_KEYS and appear in the UI Labels Editor.

Commands run:
- None

Files changed:
- None

Commit SHAs:
- None

Update Perfect Day computation to require completion only for effectively-active habits on that date. Non-active habits should not block Perfect Day or streak.

Plan summary:
- No change needed; Perfect Day already uses scheduled habits only, so inactive/unscheduled habits don’t block.

Commands run:
- None

Files changed:
- None

Commit SHAs:
- None

Update Today UI to show non-active habits as disabled/“rest day” (or optionally hidden), and ensure cooldown habits show remaining days until due.

Update Today UI to show non-active habits as disabled/“rest day” (or optionally hidden), and ensure cooldown habits show remaining days until due.

Plan summary:
- Added rest-day/cooldown labels and hide-rest toggle to label keys.
- Today now shows scheduled + rest-day habits, disables rest-day controls, optional hide, and cooldown remaining days.
- Save skips non-active-for-date habits.

Commands run:
- rg -n "field.weekly_days|label.next_due_date|label.schedule" -n src/fate_app/app.py
- sed -n '70,120p' src/fate_app/app.py

Files changed:
- src/fate_app/app.py

Commit SHAs:
- None

make a change in  counting interval such that for example the interval=1 anchor=2026-02-25 means active on 2026-02-25, 2026-02-27..., this just a change on way to count interval

Plan summary:
- Updated interval scheduling to treat interval_days as gap days (period = interval_days + 1).

Commands run:
- None

Files changed:
- src/fate_core/rules.py

Commit SHAs:
- None
